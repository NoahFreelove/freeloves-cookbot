@inject CurrentUserService UserService
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">Enter Password for @UserName</MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="_password" Label="Password" Variant="Variant.Outlined"
                      InputType="InputType.Password" Class="mt-2"
                      OnKeyDown="HandleKeyDown" Immediate="true" />
        @if (_error)
        {
            <MudText Color="Color.Error" Typo="Typo.body2" Class="mt-2">Incorrect password.</MudText>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit"
                   Disabled="@string.IsNullOrWhiteSpace(_password)">Unlock</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public int UserId { get; set; }
    [Parameter] public string UserName { get; set; } = "";

    private string _password = "";
    private bool _error;

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_password))
            await Submit();
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task Submit()
    {
        _error = false;
        if (await UserService.VerifyPasswordAsync(UserId, _password))
        {
            MudDialog.Close(DialogResult.Ok(true));
        }
        else
        {
            _error = true;
            _password = "";
        }
    }
}
